<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox Elemental - Laboratorio de Part√≠culas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-dark: #0a0e15;
            --bg-panel: #131920;
            --accent-cyan: #00fff2;
            --accent-magenta: #ff00aa;
            --accent-yellow: #ffeb3b;
            --text-primary: #e0e7ff;
            --text-secondary: #7a8aaa;
            --border-glow: rgba(0, 255, 242, 0.3);
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1430 100%);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 242, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 242, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            animation: gridMove 20s linear infinite;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        header {
            background: var(--bg-panel);
            padding: 1.5rem 2rem;
            border-bottom: 2px solid var(--accent-cyan);
            box-shadow: 0 4px 20px rgba(0, 255, 242, 0.2);
            position: relative;
            z-index: 10;
        }
        
        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-magenta));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 30px rgba(0, 255, 242, 0.5);
            animation: titlePulse 3s ease-in-out infinite;
        }
        
        @keyframes titlePulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }
        
        .container {
            display: flex;
            flex: 1;
            gap: 1.5rem;
            padding: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .sidebar {
            background: var(--bg-panel);
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 1.5rem;
            width: 320px;
            box-shadow: 0 8px 32px rgba(0, 255, 242, 0.15);
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }
        
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 4px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--accent-cyan);
            border-radius: 4px;
        }
        
        .material-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        
        .material-btn {
            background: linear-gradient(135deg, var(--bg-dark), #1a1f2e);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-primary);
        }
        
        .material-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .material-btn:hover::before {
            opacity: 1;
        }
        
        .material-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 242, 0.3);
        }
        
        .material-btn.active {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px var(--border-glow), inset 0 0 20px rgba(0, 255, 242, 0.1);
            animation: activePulse 2s ease-in-out infinite;
        }
        
        @keyframes activePulse {
            0%, 100% { box-shadow: 0 0 20px var(--border-glow), inset 0 0 20px rgba(0, 255, 242, 0.1); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 242, 0.5), inset 0 0 30px rgba(0, 255, 242, 0.2); }
        }
        
        .material-color {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            margin: 0 auto 0.5rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .controls {
            background: rgba(19, 25, 32, 0.8);
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .control-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .btn-control {
            background: linear-gradient(135deg, var(--bg-dark), #1a1f2e);
            border: 2px solid var(--accent-magenta);
            color: var(--text-primary);
            padding: 0.7rem 1.2rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            width: 100%;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }
        
        .btn-control:hover {
            background: linear-gradient(135deg, #1a1f2e, var(--bg-dark));
            box-shadow: 0 4px 15px rgba(255, 0, 170, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-control:active {
            transform: translateY(0);
        }
        
        .slider-container {
            margin-top: 1rem;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-yellow);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.6);
            border: 2px solid var(--bg-dark);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent-yellow);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 235, 59, 0.6);
            border: 2px solid var(--bg-dark);
        }
        
        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        canvas {
            border: 3px solid var(--accent-cyan);
            border-radius: 12px;
            box-shadow: 
                0 0 40px rgba(0, 255, 242, 0.4),
                0 0 80px rgba(255, 0, 170, 0.2);
            cursor: crosshair;
            background: #000000;
            animation: canvasGlow 4s ease-in-out infinite;
        }
        
        @keyframes canvasGlow {
            0%, 100% { 
                box-shadow: 
                    0 0 40px rgba(0, 255, 242, 0.4),
                    0 0 80px rgba(255, 0, 170, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 60px rgba(0, 255, 242, 0.6),
                    0 0 100px rgba(255, 0, 170, 0.3);
            }
        }
        
        .info-text {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            line-height: 1.4;
        }
        
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 255, 242, 0.3);
        }
    </style>
</head>
<body>
    <header>
        <h1>‚öõ Sandbox Elemental ‚öõ</h1>
    </header>
    
    <div class="container">
        <aside class="sidebar">
            <div class="section-title">Materiales</div>
            <div class="material-grid" id="materialGrid"></div>
            
            <div class="controls">
                <div class="section-title">Controles</div>
                <label class="control-label">Tama√±o del Pincel</label>
                <div class="slider-container">
                    <input type="range" id="brushSize" min="1" max="20" value="5">
                    <div class="info-text">Tama√±o: <span id="brushValue">5</span>px</div>
                </div>
                
                <button class="btn-control" id="clearBtn">üóëÔ∏è Limpiar Todo</button>
                <button class="btn-control" id="pauseBtn">‚è∏Ô∏è Pausar</button>
                
                <div class="info-text" style="margin-top: 1rem;">
                    üí° Click y arrastra para dibujar<br>
                    üé® Experimenta con reacciones<br>
                    üî• Portal: Marco obsidiana + fuego dentro!<br>
                    üß™ Nueva: Sodio + agua = EXPLOSI√ìN<br>
                    ‚öóÔ∏è Combina materiales y descubre!
                </div>
            </div>
        </aside>
        
        <div class="canvas-container">
            <canvas id="canvas" width="800" height="600"></canvas>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const pixelSize = 2;
        const width = 400;
        const height = 300;
        
        let grid = Array(height).fill(null).map(() => Array(width).fill(null));
        let selectedMaterial = 'sand';
        let brushSize = 5;
        let isDrawing = false;
        let isPaused = false;
        
        // Definici√≥n de materiales (AMPLIADA)
        const MATERIALS = {
            sand: { name: 'Arena', color: '#f4a460', density: 1.5, type: 'powder' },
            water: { name: 'Agua', color: '#1e90ff', density: 1, type: 'liquid' },
            stone: { name: 'Piedra', color: '#696969', density: 10, type: 'solid' },
            fire: { name: 'Fuego', color: '#ff4500', density: 0.1, type: 'gas', life: 60 },
            ice: { name: 'Hielo', color: '#87ceeb', density: 0.9, type: 'solid' },
            lava: { name: 'Lava', color: '#ff4500', density: 2, type: 'liquid', hot: true },
            plant: { name: 'Planta', color: '#32cd32', density: 0.8, type: 'solid' },
            explosive: { name: 'C4', color: '#ffeb3b', density: 1, type: 'solid' },
            steam: { name: 'Vapor', color: '#f0f0f0', density: 0.05, type: 'gas', life: 120 },
            acid: { name: '√Åcido', color: '#adff2f', density: 1.2, type: 'liquid' },
            metal: { name: 'Metal', color: '#b8b8b8', density: 7, type: 'solid', conductive: true },
            oil: { name: 'Aceite', color: '#654321', density: 0.8, type: 'liquid', flammable: true },
            wood: { name: 'Madera', color: '#8b4513', density: 0.6, type: 'solid', flammable: true },
            gunpowder: { name: 'P√≥lvora', color: '#2f2f2f', density: 1.3, type: 'powder', explosive: true },
            petroleum: { name: 'Petr√≥leo', color: '#1a1a1a', density: 0.85, type: 'liquid', flammable: true },
            seed: { name: 'Semilla', color: '#a0522d', density: 1.2, type: 'powder' },
            glass: { name: 'Vidrio', color: '#e6f3ff', density: 2.5, type: 'solid' },
            smoke: { name: 'Humo', color: '#505050', density: 0.03, type: 'gas', life: 150 },
            salt: { name: 'Sal', color: '#ffffff', density: 2.1, type: 'powder' },
            concrete: { name: 'Hormig√≥n', color: '#888888', density: 2.4, type: 'solid', resistant: true },
            coal: { name: 'Carb√≥n', color: '#1c1c1c', density: 1.4, type: 'solid', flammable: true },
            obsidian: { name: 'Obsidiana', color: '#0f0820', density: 2.6, type: 'solid', portal: true },
            dirt: { name: 'Tierra', color: '#5c4033', density: 1.6, type: 'powder', fertile: true },
            methane: { name: 'Metano', color: '#90ee90', density: 0.02, type: 'gas', explosive: true, life: 200 },
            plasma: { name: 'Plasma', color: '#ff00ff', density: 0.08, type: 'gas', life: 80, hot: true },
            uranium: { name: 'Uranio', color: '#00ff00', density: 19, type: 'solid' },
            neutron: { name: 'Neutr√≥n', color: '#00ffff', density: 0.5, type: 'energy', life: 50 },
            electricity: { name: 'Electric', color: '#ffff00', density: 0, type: 'energy', life: 15 },
            concrete_powder: { name: 'P.Hormig√≥n', color: '#a9a9a9', density: 1.8, type: 'powder' },
            tnt: { name: 'TNT', color: '#ff0000', density: 1.5, type: 'solid', explosive: true },
            brick: { name: 'Ladrillo', color: '#b22222', density: 2.0, type: 'solid', resistant: true },
            clay: { name: 'Arcilla', color: '#b8860b', density: 1.7, type: 'powder' },
            portal: { name: 'Portal', color: '#8b00ff', density: 0, type: 'special' },
            mercury: { name: 'Mercurio', color: '#c0c0c0', density: 13.5, type: 'liquid', toxic: true },
            sodium: { name: 'Sodio', color: '#ffd700', density: 0.97, type: 'solid', reactive: true },
            chlorine: { name: 'Cloro', color: '#ccff00', density: 0.003, type: 'gas', toxic: true, life: 180 },
            hydrogen: { name: 'Hidr√≥geno', color: '#ffe6e6', density: 0.00009, type: 'gas', explosive: true, life: 200 },
            oxygen: { name: 'Ox√≠geno', color: '#e6f7ff', density: 0.0014, type: 'gas', life: 250 },
            magma: { name: 'Magma', color: '#ff6600', density: 3, type: 'liquid', hot: true },
            copper: { name: 'Cobre', color: '#b87333', density: 8.96, type: 'solid', conductive: true },
            gold: { name: 'Oro', color: '#ffd700', density: 19.3, type: 'solid' },
            silver: { name: 'Plata', color: '#c0c0c0', density: 10.5, type: 'solid', conductive: true },
            phosphorus: { name: 'F√≥sforo', color: '#ffffe0', density: 1.82, type: 'solid', flammable: true },
            sulfur: { name: 'Azufre', color: '#ffff00', density: 2.07, type: 'powder', flammable: true },
            carbon: { name: 'Carbono', color: '#3c3c3c', density: 2.26, type: 'powder' },
            nitrogen: { name: 'Nitr√≥geno', color: '#add8e6', density: 0.00125, type: 'gas', life: 300 },
            helium: { name: 'Helio', color: '#ffc0cb', density: 0.00018, type: 'gas', life: 400 },
            neon: { name: 'Ne√≥n', color: '#ff6347', density: 0.0009, type: 'gas', life: 350 },
            ammonia: { name: 'Amon√≠aco', color: '#e0ffff', density: 0.00073, type: 'gas', toxic: true, life: 180 }
        };
        
        // Inicializar interfaz
        function initUI() {
            const materialGrid = document.getElementById('materialGrid');
            
            Object.keys(MATERIALS).forEach(key => {
                const material = MATERIALS[key];
                const btn = document.createElement('button');
                btn.className = 'material-btn';
                btn.innerHTML = `
                    <div class="material-color" style="background: ${material.color}"></div>
                    <div>${material.name}</div>
                `;
                btn.onclick = () => {
                    document.querySelectorAll('.material-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedMaterial = key;
                };
                materialGrid.appendChild(btn);
            });
            
            document.querySelector('.material-btn').classList.add('active');
            
            document.getElementById('brushSize').oninput = (e) => {
                brushSize = parseInt(e.target.value);
                document.getElementById('brushValue').textContent = brushSize;
            };
            
            document.getElementById('clearBtn').onclick = () => {
                grid = Array(height).fill(null).map(() => Array(width).fill(null));
            };
            
            document.getElementById('pauseBtn').onclick = function() {
                isPaused = !isPaused;
                this.textContent = isPaused ? '‚ñ∂Ô∏è Reanudar' : '‚è∏Ô∏è Pausar';
            };
        }
        
        // Funciones de movimiento
        function movePowder(x, y) {
            const particle = grid[y][x];
            if (!particle) return false;
            
            const speed = Math.min(Math.ceil(particle.density / 1.5), 3);
            
            for (let i = 1; i <= speed; i++) {
                if (y + i < height && !grid[y + i][x]) {
                    grid[y + i][x] = particle;
                    grid[y][x] = null;
                    return true;
                }
            }
            
            const dir = Math.random() < 0.5 ? -1 : 1;
            if (y < height - 1) {
                if (x + dir >= 0 && x + dir < width && !grid[y + 1][x + dir]) {
                    grid[y + 1][x + dir] = particle;
                    grid[y][x] = null;
                    return true;
                }
                if (x - dir >= 0 && x - dir < width && !grid[y + 1][x - dir]) {
                    grid[y + 1][x - dir] = particle;
                    grid[y][x] = null;
                    return true;
                }
            }
            return false;
        }
        
        function moveLiquid(x, y) {
            const particle = grid[y][x];
            if (!particle) return false;
            
            if (y < height - 1 && !grid[y + 1][x]) {
                grid[y + 1][x] = particle;
                grid[y][x] = null;
                return true;
            }
            
            const dir = Math.random() < 0.5 ? -1 : 1;
            for (let i = 1; i <= 3; i++) {
                if (x + dir * i >= 0 && x + dir * i < width && !grid[y][x + dir * i]) {
                    grid[y][x + dir * i] = particle;
                    grid[y][x] = null;
                    return true;
                }
            }
            return false;
        }
        
        function moveGas(x, y, speed = 0.8) {
            const particle = grid[y][x];
            if (!particle) return false;
            
            if (y > 0 && Math.random() < speed) {
                const drift = Math.floor(Math.random() * 3) - 1;
                const nx = x + drift;
                if (nx >= 0 && nx < width && !grid[y - 1][nx]) {
                    grid[y - 1][nx] = particle;
                    grid[y][x] = null;
                    return true;
                }
            }
            return false;
        }
        
        function explode(x, y, radius) {
            for (let dy = -radius; dy <= radius; dy += 2) {
                for (let dx = -radius; dx <= radius; dx += 2) {
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist <= radius) {
                        const nx = x + dx;
                        const ny = y + dy;
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                            const intensity = 1 - dist / radius;
                            if (Math.random() < intensity * 0.8) {
                                if (dist < radius * 0.4) {
                                    grid[ny][nx] = { type: 'plasma', life: 60 };
                                } else {
                                    grid[ny][nx] = { type: 'fire', life: 50 };
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // NUEVA: Propagaci√≥n de calor en 3D
        function propagateHeat(x, y, heatType, radius, probability, convertTo) {
            const queue = [[x, y, 0]];
            const visited = new Set();
            visited.add(`${x},${y}`);
            
            while (queue.length > 0) {
                const [cx, cy, depth] = queue.shift();
                if (depth >= radius) continue;
                
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;
                        const nx = cx + dx;
                        const ny = cy + dy;
                        const key = `${nx},${ny}`;
                        
                        if (nx >= 0 && nx < width && ny >= 0 && ny < height && 
                            !visited.has(key)) {
                            visited.add(key);
                            const neighbor = grid[ny][nx];
                            
                            if (neighbor && neighbor.type === heatType) {
                                const chance = probability / (depth + 1);
                                if (Math.random() < chance) {
                                    if (convertTo) {
                                        grid[ny][nx] = { type: convertTo };
                                    } else {
                                        grid[ny][nx].heating = true;
                                    }
                                    queue.push([nx, ny, depth + 1]);
                                }
                            }
                        }
                    }
                }
            }
        }
        
        // Sistema de actualizaci√≥n
        function updateParticle(x, y) {
            const particle = grid[y][x];
            if (!particle) return;
            
            const type = particle.type;
            const mat = MATERIALS[type];
            if (!mat) return;
            
            // Vida
            if (particle.life !== undefined) {
                particle.life--;
                if (particle.life <= 0) {
                    if (type === 'fire' || type === 'plasma') {
                        grid[y][x] = Math.random() < 0.3 ? { type: 'smoke', life: 100 } : null;
                    } else if (type === 'chlorine') {
                        grid[y][x] = null;
                    } else {
                        grid[y][x] = null;
                    }
                    return;
                }
            }
            
            // Movimiento
            if (mat.type === 'powder') {
                movePowder(x, y);
            } else if (mat.type === 'liquid') {
                moveLiquid(x, y);
            } else if (mat.type === 'gas') {
                const speed = type === 'methane' ? 0.95 : 
                             type === 'hydrogen' ? 0.98 : 
                             type === 'helium' ? 0.99 : 0.8;
                moveGas(x, y, speed);
            } else if (type === 'neutron') {
                const vx = particle.vx || 1;
                const vy = particle.vy || 0;
                const nx = x + vx;
                const ny = y + vy;
                if (nx >= 0 && nx < width && ny >= 0 && ny < height && !grid[ny][nx]) {
                    grid[ny][nx] = particle;
                    grid[y][x] = null;
                } else {
                    grid[y][x] = null;
                }
                return;
            }
            
            checkReactions(x, y);
        }
        
        // SISTEMA DE REACCIONES MEJORADO Y AMPLIADO
        function checkReactions(x, y) {
            const particle = grid[y][x];
            if (!particle) return;
            
            const type = particle.type;
            
            for (let dy = -1; dy <= 1; dy++) {
                for (let dx = -1; dx <= 1; dx++) {
                    if (dx === 0 && dy === 0) continue;
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx < 0 || nx >= width || ny < 0 || ny >= height) continue;
                    
                    const neighbor = grid[ny][nx];
                    if (!neighbor) continue;
                    
                    // ========== REACCIONES VIOLENTAS ==========
                    
                    // Sodio + Agua = GRAN EXPLOSI√ìN + Hidr√≥geno
                    if ((type === 'sodium' && neighbor.type === 'water') ||
                        (type === 'water' && neighbor.type === 'sodium')) {
                        explode(x, y, 18);
                        // Crear hidr√≥geno
                        for (let i = 0; i < 12; i++) {
                            const angle = (Math.PI * 2 * i) / 12;
                            const fx = Math.round(x + Math.cos(angle) * 8);
                            const fy = Math.round(y + Math.sin(angle) * 8);
                            if (fx >= 0 && fx < width && fy >= 0 && fy < height && !grid[fy][fx]) {
                                grid[fy][fx] = { type: 'hydrogen', life: 150 };
                            }
                        }
                        return;
                    }
                    
                    // Hidr√≥geno + Ox√≠geno + Fuego = Agua + Explosi√≥n
                    if ((type === 'hydrogen' && neighbor.type === 'oxygen') ||
                        (type === 'oxygen' && neighbor.type === 'hydrogen')) {
                        // Buscar fuego cercano
                        let hasFire = false;
                        for (let sy = -2; sy <= 2; sy++) {
                            for (let sx = -2; sx <= 2; sx++) {
                                const cy = y + sy;
                                const cx = x + sx;
                                if (cx >= 0 && cx < width && cy >= 0 && cy < height) {
                                    const check = grid[cy][cx];
                                    if (check && (check.type === 'fire' || check.type === 'plasma')) {
                                        hasFire = true;
                                        break;
                                    }
                                }
                            }
                        }
                        if (hasFire && Math.random() < 0.15) {
                            explode(x, y, 12);
                            grid[y][x] = { type: 'water' };
                            grid[ny][nx] = { type: 'steam', life: 100 };
                            return;
                        }
                    }
                    
                    // F√≥sforo + Ox√≠geno = Fuego intenso
                    if ((type === 'phosphorus' && neighbor.type === 'oxygen') ||
                        (type === 'oxygen' && neighbor.type === 'phosphorus')) {
                        if (Math.random() < 0.1) {
                            grid[y][x] = { type: 'fire', life: 120 };
                            grid[ny][nx] = { type: 'fire', life: 120 };
                            return;
                        }
                    }
                    
                    // ========== LAVA Y CALOR ==========
                    
                    // Lava + Agua = Piedra + Vapor (con propagaci√≥n)
                    if (type === 'lava' && neighbor.type === 'water') {
                        grid[y][x] = { type: 'stone' };
                        grid[ny][nx] = { type: 'steam', life: 100 };
                        for (let i = 0; i < 6; i++) {
                            const angle = (Math.PI * 2 * i) / 6;
                            const fx = Math.round(x + Math.cos(angle) * 2);
                            const fy = Math.round(y + Math.sin(angle) * 2);
                            if (fx >= 0 && fx < width && fy >= 0 && fy < height && !grid[fy][fx]) {
                                grid[fy][fx] = { type: 'steam', life: 80 };
                            }
                        }
                        return;
                    }
                    
                    // Magma m√°s caliente
                    if (type === 'magma' && neighbor.type === 'water') {
                        grid[y][x] = { type: 'lava' };
                        grid[ny][nx] = { type: 'steam', life: 120 };
                        explode(x, y, 8);
                        return;
                    }
                    
                    // ========== COMBUSTI√ìN MEJORADA ==========
                    
                    if ((type === 'fire' || type === 'lava' || type === 'plasma' || type === 'magma') && 
                        Math.random() < 0.2) {
                        if (neighbor.type === 'oil' || neighbor.type === 'petroleum') {
                            grid[ny][nx] = { type: 'fire', life: 120 };
                            // Propagar
                            if (Math.random() < 0.3) {
                                for (let i = 0; i < 4; i++) {
                                    const dirs = [[0,-1],[0,1],[-1,0],[1,0]];
                                    const [ddx, ddy] = dirs[i];
                                    const fx = nx + ddx;
                                    const fy = ny + ddy;
                                    if (fx >= 0 && fx < width && fy >= 0 && fy < height) {
                                        const check = grid[fy][fx];
                                        if (check && (check.type === 'oil' || check.type === 'petroleum')) {
                                            grid[fy][fx] = { type: 'fire', life: 100 };
                                        }
                                    }
                                }
                            }
                        } else if (neighbor.type === 'wood' && !neighbor.burning) {
                            neighbor.burning = true;
                            neighbor.burnTime = 150;
                        } else if (neighbor.type === 'gunpowder') {
                            explode(nx, ny, 10);
                            return;
                        } else if (neighbor.type === 'plant') {
                            grid[ny][nx] = { type: 'fire', life: 50 };
                        } else if (neighbor.type === 'methane') {
                            explode(nx, ny, 15);
                            return;
                        } else if (neighbor.type === 'coal' && !neighbor.burning) {
                            neighbor.burning = true;
                            neighbor.burnTime = 300;
                        } else if (neighbor.type === 'sulfur') {
                            grid[ny][nx] = { type: 'fire', life: 80 };
                            // Propagar a azufre cercano
                            propagateHeat(nx, ny, 'sulfur', 3, 0.4, 'fire');
                        } else if (neighbor.type === 'phosphorus') {
                            grid[ny][nx] = { type: 'fire', life: 100 };
                        }
                    }
                    
                    // ========== EXPLOSIVOS ==========
                    
                    if ((type === 'explosive' || type === 'tnt') && 
                        (neighbor.type === 'fire' || neighbor.type === 'lava' || 
                         neighbor.type === 'electricity' || neighbor.type === 'plasma')) {
                        explode(x, y, type === 'tnt' ? 20 : 15);
                        return;
                    }
                    
                    // ========== HIELO Y CONGELACI√ìN ==========
                    
                    if (type === 'ice' && Math.random() < 0.02) {
                        if (neighbor.type === 'water') {
                            grid[ny][nx] = { type: 'ice' };
                            // Propagaci√≥n de congelaci√≥n mejorada
                            propagateHeat(nx, ny, 'water', 4, 0.3, 'ice');
                        } else if (neighbor.type === 'fire' || neighbor.type === 'lava') {
                            grid[ny][nx] = { type: 'water' };
                        }
                    }
                    
                    // ========== PLANTAS Y SEMILLAS ==========
                    
                    if (type === 'seed' && neighbor.type === 'water' && Math.random() < 0.05) {
                        grid[y][x] = { type: 'plant', growth: 0 };
                        if (y > 0 && !grid[y-1][x]) {
                            grid[y-1][x] = { type: 'plant', growth: 0 };
                        }
                        return;
                    }
                    
                    if (type === 'seed' && neighbor.type === 'dirt' && neighbor.wet && Math.random() < 0.08) {
                        grid[y][x] = { type: 'plant', growth: 0 };
                        return;
                    }
                    
                    // ========== TIERRA ==========
                    
                    if (type === 'dirt' && neighbor.type === 'water' && !particle.wet && Math.random() < 0.1) {
                        particle.wet = true;
                        particle.color = '#3d2817';
                        grid[ny][nx] = null;
                        propagateHeat(x, y, 'dirt', 5, 0.4, null);
                        for (let dy2 = -1; dy2 <= 1; dy2++) {
                            for (let dx2 = -1; dx2 <= 1; dx2++) {
                                const nx2 = x + dx2;
                                const ny2 = y + dy2;
                                if (nx2 >= 0 && nx2 < width && ny2 >= 0 && ny2 < height) {
                                    const n2 = grid[ny2][nx2];
                                    if (n2 && n2.type === 'dirt' && !n2.wet && Math.random() < 0.4) {
                                        n2.wet = true;
                                        n2.color = '#3d2817';
                                    }
                                }
                            }
                        }
                    }
                    
                    // ========== HORMIG√ìN ==========
                    
                    if (type === 'concrete_powder' && neighbor.type === 'water' && Math.random() < 0.3) {
                        grid[y][x] = { type: 'concrete' };
                        if (Math.random() < 0.5) grid[ny][nx] = null;
                        // MEJORADO: Propagaci√≥n completa hacia abajo y lados
                        propagateHeat(x, y, 'concrete_powder', 8, 0.5, 'concrete');
                        return;
                    }
                    
                    // ========== ARCILLA -> LADRILLO (MEJORADO) ==========
                    
                    if (type === 'clay' && (neighbor.type === 'lava' || neighbor.type === 'fire' || 
                        neighbor.type === 'plasma' || neighbor.type === 'magma') && Math.random() < 0.08) {
                        grid[y][x] = { type: 'brick' };
                        // MEJORADO: Propagaci√≥n completa de cocci√≥n
                        propagateHeat(x, y, 'clay', 15, 0.6, 'brick');
                        return;
                    }
                    
                    // ========== ARENA -> VIDRIO ==========
                    
                    if (type === 'lava' && neighbor.type === 'sand' && Math.random() < 0.08) {
                        grid[ny][nx] = { type: 'glass' };
                        propagateHeat(nx, ny, 'sand', 4, 0.4, 'glass');
                    }
                    
                    // ========== METAL Y √ìXIDO ==========
                    
                    if (type === 'metal' && neighbor.type === 'water' && Math.random() < 0.002) {
                        grid[y][x] = { type: 'sand', color: '#b7410e' };
                        propagateHeat(x, y, 'metal', 3, 0.15, null);
                        for (let dy2 = -1; dy2 <= 1; dy2++) {
                            for (let dx2 = -1; dx2 <= 1; dx2++) {
                                const nx2 = x + dx2;
                                const ny2 = y + dy2;
                                if (nx2 >= 0 && nx2 < width && ny2 >= 0 && ny2 < height) {
                                    const n2 = grid[ny2][nx2];
                                    if (n2 && n2.type === 'metal' && Math.random() < 0.1) {
                                        grid[ny2][nx2] = { type: 'sand', color: '#b7410e' };
                                    }
                                }
                            }
                        }
                    }
                    
                    // ========== √ÅCIDO ==========
                    
                    if (type === 'acid' && Math.random() < 0.15) {
                        if (neighbor.type === 'metal' || neighbor.type === 'copper' || 
                            neighbor.type === 'silver') {
                            grid[ny][nx] = { type: 'smoke', life: 80 };
                            if (Math.random() < 0.3) {
                                grid[y][x] = null; // El √°cido se consume
                            }
                        } else if (neighbor.type === 'stone' || neighbor.type === 'concrete') {
                            if (Math.random() < 0.05) {
                                grid[ny][nx] = { type: 'sand', color: '#888888' };
                            }
                        } else if (neighbor.type === 'wood' || neighbor.type === 'plant') {
                            grid[ny][nx] = { type: 'smoke', life: 60 };
                        }
                    }
                    
                    // ========== MERCURIO ==========
                    
                    if (type === 'mercury' && neighbor.type === 'metal' && Math.random() < 0.03) {
                        grid[ny][nx] = { type: 'mercury' };
                    }
                    
                    if (type === 'mercury' && (neighbor.type === 'gold' || neighbor.type === 'silver') && 
                        Math.random() < 0.01) {
                        // Amalgama
                        grid[ny][nx] = { type: 'mercury', color: '#d4af37' };
                    }
                    
                    // ========== CLORO ==========
                    
                    if (type === 'chlorine' && Math.random() < 0.1) {
                        if (neighbor.type === 'sodium') {
                            grid[y][x] = { type: 'salt' };
                            grid[ny][nx] = { type: 'salt' };
                            return;
                        } else if (neighbor.type === 'hydrogen') {
                            grid[y][x] = { type: 'acid' };
                            grid[ny][nx] = null;
                            return;
                        }
                    }
                    
                    // ========== URANIO ==========
                    
                    if (type === 'uranium' && neighbor.type === 'neutron' && Math.random() < 0.5) {
                        explode(x, y, 20);
                        for (let i = 0; i < 8; i++) {
                            const angle = (Math.PI * 2 * i) / 8;
                            const fx = Math.round(x + Math.cos(angle) * 5);
                            const fy = Math.round(y + Math.sin(angle) * 5);
                            if (fx >= 0 && fx < width && fy >= 0 && fy < height) {
                                grid[fy][fx] = { type: 'neutron', life: 50, 
                                               vx: Math.round(Math.cos(angle) * 2), 
                                               vy: Math.round(Math.sin(angle) * 2) };
                            }
                        }
                        return;
                    }
                    
                    // ========== ELECTRICIDAD ==========
                    
                    if (type === 'electricity' && neighbor.conductive && Math.random() < 0.4) {
                        grid[ny][nx] = { type: 'electricity', life: 15 };
                    }
                    
                    if (type === 'electricity' && neighbor.type === 'water' && Math.random() < 0.2) {
                        grid[ny][nx] = { type: 'electricity', life: 10 };
                    }
                    
                    // ========== AMON√çACO ==========
                    
                    if (type === 'ammonia' && neighbor.type === 'fire' && Math.random() < 0.15) {
                        explode(x, y, 10);
                        for (let i = 0; i < 6; i++) {
                            const angle = (Math.PI * 2 * i) / 6;
                            const fx = Math.round(x + Math.cos(angle) * 4);
                            const fy = Math.round(y + Math.sin(angle) * 4);
                            if (fx >= 0 && fx < width && fy >= 0 && fy < height) {
                                grid[fy][fx] = { type: 'nitrogen', life: 150 };
                            }
                        }
                        return;
                    }
                    
                    // ========== PORTALES MEJORADOS ==========
                    
                    if (type === 'portal' && Math.random() < 0.05 && 
                        neighbor.type !== 'portal' && neighbor.type !== 'obsidian') {
                        for (let py = Math.max(0, y - 100); py < Math.min(height, y + 100); py += 5) {
                            for (let px = Math.max(0, x - 100); px < Math.min(width, x + 100); px += 5) {
                                const p = grid[py][px];
                                if (p && p.type === 'portal' && (px !== x || py !== y)) {
                                    for (let ty = -2; ty <= 2; ty++) {
                                        for (let tx = -2; tx <= 2; tx++) {
                                            const tpx = px + tx;
                                            const tpy = py + ty;
                                            if (tpx >= 0 && tpx < width && tpy >= 0 && tpy < height && !grid[tpy][tpx]) {
                                                grid[tpy][tpx] = neighbor;
                                                grid[ny][nx] = null;
                                                return;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // ========== COMPORTAMIENTOS ESPECIALES ==========
            
            if (type === 'wood' && particle.burning) {
                particle.burnTime = (particle.burnTime || 150) - 1;
                if (particle.burnTime <= 0) {
                    grid[y][x] = { type: 'fire', life: 30 };
                } else if (Math.random() < 0.1 && y > 0 && !grid[y-1][x]) {
                    grid[y-1][x] = { type: 'smoke', life: 120 };
                }
            }
            
            if (type === 'coal' && particle.burning) {
                particle.burnTime = (particle.burnTime || 300) - 1;
                if (particle.burnTime <= 0) {
                    grid[y][x] = null;
                } else if (Math.random() < 0.15 && y > 0 && !grid[y-1][x]) {
                    grid[y-1][x] = { type: 'fire', life: 70 };
                }
            }
            
            if (type === 'plant' && Math.random() < 0.015) {
                particle.growth = (particle.growth || 0) + 1;
                if (particle.growth < 5) {
                    const dirs = [[0, -1], [-1, 0], [1, 0]];
                    const dir = dirs[Math.floor(Math.random() * dirs.length)];
                    const nx = x + dir[0];
                    const ny = y + dir[1];
                    if (nx >= 0 && nx < width && ny >= 0 && ny < height && !grid[ny][nx]) {
                        grid[ny][nx] = { type: 'plant', growth: 0 };
                    }
                }
            }
            
            if (type === 'uranium' && Math.random() < 0.01) {
                const angle = Math.random() * Math.PI * 2;
                const nx = Math.round(x + Math.cos(angle));
                const ny = Math.round(y + Math.sin(angle));
                if (nx >= 0 && nx < width && ny >= 0 && ny < height && !grid[ny][nx]) {
                    grid[ny][nx] = { type: 'neutron', life: 50, 
                                   vx: Math.round(Math.cos(angle) * 2), 
                                   vy: Math.round(Math.sin(angle) * 2) };
                }
            }
            
            // MEJORADO: Detecci√≥n de portales con fuego
            if (type === 'obsidian' && Math.random() < 0.02) {
                checkPortalFrame(x, y);
            }
        }
        
        // MEJORADO: Detector de portales que se activa con FUEGO
        function checkPortalFrame(x, y) {
            // Buscar marcos de diferentes tama√±os
            for (let w = 3; w <= 6; w++) {
                for (let h = 4; h <= 8; h++) {
                    if (isValidPortalFrame(x, y, w, h)) {
                        // Verificar si hay fuego DENTRO del marco
                        let hasFire = false;
                        for (let dy = 1; dy < h - 1; dy++) {
                            for (let dx = 1; dx < w - 1; dx++) {
                                const check = grid[y + dy][x + dx];
                                if (check && (check.type === 'fire' || check.type === 'lava' || 
                                             check.type === 'plasma' || check.type === 'magma')) {
                                    hasFire = true;
                                    break;
                                }
                            }
                            if (hasFire) break;
                        }
                        
                        // Si hay fuego, activar portal
                        if (hasFire) {
                            for (let dy = 1; dy < h - 1; dy++) {
                                for (let dx = 1; dx < w - 1; dx++) {
                                    grid[y + dy][x + dx] = { type: 'portal' };
                                }
                            }
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        function isValidPortalFrame(x, y, w, h) {
            // Verificar l√≠mites
            if (x + w > width || y + h > height) return false;
            
            // Verificar marco completo de obsidiana
            for (let dx = 0; dx < w; dx++) {
                if (!grid[y][x + dx] || grid[y][x + dx].type !== 'obsidian') return false;
                if (!grid[y + h - 1][x + dx] || grid[y + h - 1][x + dx].type !== 'obsidian') return false;
            }
            for (let dy = 0; dy < h; dy++) {
                if (!grid[y + dy][x] || grid[y + dy][x].type !== 'obsidian') return false;
                if (!grid[y + dy][x + w - 1] || grid[y + dy][x + w - 1].type !== 'obsidian') return false;
            }
            return true;
        }
        
        // Dibujo
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            drawParticles(e);
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (isDrawing) drawParticles(e);
        });
        
        canvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });
        
        canvas.addEventListener('mouseleave', () => {
            isDrawing = false;
        });
        
        function drawParticles(e) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((e.clientX - rect.left) / pixelSize);
            const y = Math.floor((e.clientY - rect.top) / pixelSize);
            
            for (let dy = -brushSize; dy <= brushSize; dy++) {
                for (let dx = -brushSize; dx <= brushSize; dx++) {
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist <= brushSize) {
                        const px = x + dx;
                        const py = y + dy;
                        if (px >= 0 && px < width && py >= 0 && py < height && !grid[py][px]) {
                            grid[py][px] = { type: selectedMaterial };
                        }
                    }
                }
            }
        }
        
        // Loop principal
        let frameCount = 0;
        function update() {
            if (!isPaused) {
                frameCount++;
                const startX = frameCount % 2 === 0 ? 0 : width - 1;
                const endX = startX === 0 ? width : -1;
                const stepX = startX === 0 ? 1 : -1;
                
                for (let y = height - 1; y >= 0; y--) {
                    for (let x = startX; x !== endX; x += stepX) {
                        if (grid[y][x]) {
                            updateParticle(x, y);
                        }
                    }
                }
            }
            
            render();
            requestAnimationFrame(update);
        }
        
        function render() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const particle = grid[y][x];
                    if (particle) {
                        const mat = MATERIALS[particle.type];
                        if (mat) {
                            if (particle.color) {
                                ctx.fillStyle = particle.color;
                            } else if (particle.type === 'lava') {
                                const pulse = Math.sin(Date.now() / 200) * 0.2 + 0.8;
                                ctx.fillStyle = `rgb(${Math.floor(255 * pulse)}, ${Math.floor(69 * pulse)}, 0)`;
                            } else if (particle.type === 'magma') {
                                const pulse = Math.sin(Date.now() / 150) * 0.3 + 0.7;
                                ctx.fillStyle = `rgb(${Math.floor(255 * pulse)}, ${Math.floor(102 * pulse)}, 0)`;
                            } else if (particle.type === 'plasma') {
                                const pulse = Math.sin(Date.now() / 100) * 0.5 + 0.5;
                                ctx.fillStyle = `rgb(${Math.floor(255 * pulse)}, 0, ${Math.floor(255 * (1-pulse))})`;
                            } else if (particle.type === 'portal') {
                                const pulse = Math.sin(Date.now() / 100) * 0.3 + 0.7;
                                ctx.fillStyle = `rgb(${Math.floor(139 * pulse)}, 0, ${Math.floor(255 * pulse)})`;
                            } else if (particle.type === 'uranium') {
                                const pulse = Math.sin(Date.now() / 300) * 0.3 + 0.7;
                                ctx.fillStyle = `rgb(0, ${Math.floor(255 * pulse)}, 0)`;
                            } else {
                                ctx.fillStyle = mat.color;
                            }
                            ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                        }
                    }
                }
            }
        }
        
        initUI();
        update();
    </script>
</body>
</html>
