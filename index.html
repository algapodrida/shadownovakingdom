<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox Elemental - Laboratorio de PartÃ­culas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=JetBrains+Mono:wght@400;600&display=swap');
        * { margin:0; padding:0; box-sizing:border-box; }
        :root {
            --bg-dark:#0a0e15; --bg-panel:#131920;
            --accent-cyan:#00fff2; --accent-magenta:#ff00aa;
            --accent-yellow:#ffeb3b; --text-primary:#e0e7ff;
            --text-secondary:#7a8aaa; --border-glow:rgba(0,255,242,0.3);
        }
        body { font-family:'JetBrains Mono',monospace; background:linear-gradient(135deg,var(--bg-dark) 0%,#1a1430 100%); color:var(--text-primary); overflow:hidden; height:100vh; display:flex; flex-direction:column; }
        body::before { content:''; position:fixed; top:0; left:0; width:100%; height:100%; background-image:linear-gradient(rgba(0,255,242,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,242,0.03) 1px,transparent 1px); background-size:50px 50px; pointer-events:none; animation:gridMove 20s linear infinite; }
        @keyframes gridMove { 0%{transform:translate(0,0)} 100%{transform:translate(50px,50px)} }
        header { background:var(--bg-panel); padding:0.8rem 2rem; border-bottom:2px solid var(--accent-cyan); box-shadow:0 4px 20px rgba(0,255,242,0.2); position:relative; z-index:10; }
        h1 { font-family:'Orbitron',sans-serif; font-size:1.5rem; font-weight:900; background:linear-gradient(135deg,var(--accent-cyan),var(--accent-magenta)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; text-transform:uppercase; letter-spacing:3px; animation:titlePulse 3s ease-in-out infinite; }
        @keyframes titlePulse { 0%,100%{filter:brightness(1)} 50%{filter:brightness(1.3)} }
        .container { display:flex; flex:1; gap:1rem; padding:1rem; position:relative; z-index:1; overflow:hidden; }
        .sidebar { background:var(--bg-panel); border:2px solid var(--accent-cyan); border-radius:12px; padding:0.8rem; width:268px; flex-shrink:0; box-shadow:0 8px 32px rgba(0,255,242,0.15); overflow-y:auto; max-height:calc(100vh - 100px); display:flex; flex-direction:column; gap:0.5rem; }
        .sidebar::-webkit-scrollbar{width:5px} .sidebar::-webkit-scrollbar-track{background:var(--bg-dark);border-radius:4px} .sidebar::-webkit-scrollbar-thumb{background:var(--accent-cyan);border-radius:4px}
        .mat-section-title { grid-column:1/-1; font-family:'Orbitron',sans-serif; font-size:0.55rem; font-weight:700; color:var(--accent-cyan); text-transform:uppercase; letter-spacing:2px; padding:5px 2px 3px; border-bottom:1px solid rgba(0,255,242,0.25); margin-top:3px; }
        .eraser-btn { background:linear-gradient(135deg,#1a0f0a,#2a1510); border:2px solid #ff6b35; border-radius:8px; padding:0.45rem 0.6rem; cursor:pointer; transition:all 0.3s ease; font-family:'JetBrains Mono',monospace; font-weight:600; font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:#ff6b35; width:100%; display:flex; align-items:center; justify-content:center; gap:0.4rem; }
        .eraser-btn:hover{box-shadow:0 4px 15px rgba(255,107,53,0.4);transform:translateY(-1px)}
        .eraser-btn.active{box-shadow:0 0 20px rgba(255,107,53,0.5),inset 0 0 20px rgba(255,107,53,0.1);animation:eraserPulse 2s ease-in-out infinite;color:#fff}
        @keyframes eraserPulse{0%,100%{box-shadow:0 0 20px rgba(255,107,53,0.5),inset 0 0 20px rgba(255,107,53,0.1)}50%{box-shadow:0 0 30px rgba(255,107,53,0.8),inset 0 0 30px rgba(255,107,53,0.2)}}
        .material-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:0.3rem; }
        .material-btn { background:linear-gradient(135deg,var(--bg-dark),#1a1f2e); border:1.5px solid rgba(255,255,255,0.08); border-radius:6px; padding:0.3rem 0.15rem; cursor:pointer; transition:all 0.25s ease; font-family:'JetBrains Mono',monospace; font-weight:600; font-size:0.55rem; text-transform:uppercase; letter-spacing:0.3px; color:var(--text-primary); text-align:center; }
        .material-btn:hover{transform:translateY(-1px);border-color:rgba(0,255,242,0.4);box-shadow:0 3px 10px rgba(0,255,242,0.2)}
        .material-btn.active{border-color:var(--accent-cyan);box-shadow:0 0 12px var(--border-glow),inset 0 0 12px rgba(0,255,242,0.08);animation:activePulse 2s ease-in-out infinite}
        @keyframes activePulse{0%,100%{box-shadow:0 0 12px var(--border-glow),inset 0 0 12px rgba(0,255,242,0.08)}50%{box-shadow:0 0 20px rgba(0,255,242,0.5),inset 0 0 20px rgba(0,255,242,0.15)}}
        .material-color{width:18px;height:18px;border-radius:4px;margin:0 auto 0.2rem;border:1.5px solid rgba(255,255,255,0.15);box-shadow:0 1px 4px rgba(0,0,0,0.4)}
        .controls{background:rgba(19,25,32,0.8);border:1px solid var(--accent-cyan);border-radius:8px;padding:0.7rem}
        .control-label{font-size:0.62rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:1px;margin-bottom:0.4rem;display:block}
        .btn-control{background:linear-gradient(135deg,var(--bg-dark),#1a1f2e);border:2px solid var(--accent-magenta);color:var(--text-primary);padding:0.45rem 1rem;border-radius:6px;cursor:pointer;font-family:'JetBrains Mono',monospace;font-weight:600;font-size:0.72rem;text-transform:uppercase;width:100%;margin-top:0.4rem;transition:all 0.3s ease;letter-spacing:1px}
        .btn-control:hover{box-shadow:0 4px 15px rgba(255,0,170,0.4);transform:translateY(-1px)}
        .slider-container{margin-top:0.5rem}
        input[type="range"]{width:100%;height:5px;border-radius:3px;background:linear-gradient(90deg,var(--accent-cyan),var(--accent-magenta));outline:none;-webkit-appearance:none}
        input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent-yellow);cursor:pointer;border:2px solid var(--bg-dark);box-shadow:0 0 8px rgba(255,235,59,0.6)}
        .canvas-container{flex:1;display:flex;justify-content:center;align-items:center}
        canvas{border:3px solid var(--accent-cyan);border-radius:12px;box-shadow:0 0 40px rgba(0,255,242,0.4),0 0 80px rgba(255,0,170,0.2);cursor:crosshair;background:#000;animation:canvasGlow 4s ease-in-out infinite}
        @keyframes canvasGlow{0%,100%{box-shadow:0 0 40px rgba(0,255,242,0.4),0 0 80px rgba(255,0,170,0.2)}50%{box-shadow:0 0 60px rgba(0,255,242,0.6),0 0 100px rgba(255,0,170,0.3)}}
        .info-text{font-size:0.6rem;color:var(--text-secondary);margin-top:0.5rem;line-height:1.5}
        .section-title{font-family:'Orbitron',sans-serif;font-size:0.72rem;font-weight:700;color:var(--accent-cyan);text-transform:uppercase;letter-spacing:2px;margin-bottom:0.5rem;padding-bottom:0.4rem;border-bottom:1px solid rgba(0,255,242,0.3)}
    </style>
</head>
<body>
<header><h1>âš› Sandbox Elemental âš›</h1></header>
<div class="container">
    <aside class="sidebar">
        <div class="section-title">Materiales</div>
        <button class="eraser-btn" id="eraserBtn">ğŸ§¹ Borrar (Goma)</button>
        <div class="material-grid" id="materialGrid"></div>
        <div class="controls">
            <div class="section-title">Controles</div>
            <label class="control-label">TamaÃ±o del Pincel</label>
            <div class="slider-container">
                <input type="range" id="brushSize" min="1" max="20" value="5">
                <div class="info-text">TamaÃ±o: <span id="brushValue">5</span>px</div>
            </div>
            <button class="btn-control" id="clearBtn">ğŸ—‘ï¸ Limpiar Todo</button>
            <button class="btn-control" id="pauseBtn">â¸ï¸ Pausar</button>
            <div class="info-text" style="margin-top:0.8rem">
                ğŸ’¡ Click y arrastra para dibujar<br>
                âš¡ Metales â†’ conducen electricidad<br>
                ğŸ”µ Condensador: vaporâ†’agua<br>
                ğŸ”´ PiedraFuego: aguaâ†’vapor<br>
                ğŸ§¤ Goma: aÃ­sla la electricidad<br>
                ğŸ’¡ Bombilla: se ilumina con corriente<br>
                ğŸšª Puerta: se expande con corriente<br>
                ğŸŒ¿ Planta: necesita agua para crecer<br>
                ğŸŒµ Sin agua mucho tiempo â†’ se seca<br>
                ğŸ”ª Cosechadora: rebota y borra todo
            </div>
        </div>
    </aside>
    <div class="canvas-container">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const pixelSize = 2;
const width = 400;
const height = 300;

let grid = Array(height).fill(null).map(() => Array(width).fill(null));
let selectedMaterial = 'sand';
let isErasing = false;
let brushSize = 5;
let isDrawing = false;
let isPaused = false;

// â”€â”€â”€ ORDEN DE MATERIALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MATERIAL_ORDER = [
    '__BÃ¡sicos',
    'sand','water','stone','dirt','clay','glass','salt','concrete_powder','concrete','brick',

    '__ElÃ©ctricos & Especiales',
    'condenser','firestone',
    'rubber','bulb','door','harvester',
    'electricity','metal','copper','silver','gold',
    'obsidian','portal',

    '__Fuego & Calor',
    'fire','lava','magma','plasma',
    'wood','coal','oil','petroleum',

    '__Gases',
    'steam','smoke','oxygen','hydrogen','methane',
    'nitrogen','helium','neon','ammonia','chlorine',

    '__Metales & Minerales',
    'mercury','sodium','uranium',
    'phosphorus','sulfur','carbon',

    '__Explosivos',
    'explosive','tnt','gunpowder','neutron',

    '__BiologÃ­a',
    'plant','seed','ice',

    '__QuÃ­mica',
    'acid',
];

// â”€â”€â”€ DEFINICIÃ“N DE MATERIALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MATERIALS = {
    // BÃ¡sicos
    sand:            { name:'Arena',       color:'#f4a460', density:1.5,  type:'powder' },
    water:           { name:'Agua',        color:'#1e90ff', density:1,    type:'liquid' },
    stone:           { name:'Piedra',      color:'#696969', density:10,   type:'solid'  },
    dirt:            { name:'Tierra',      color:'#5c4033', density:1.6,  type:'powder', fertile:true },
    clay:            { name:'Arcilla',     color:'#b8860b', density:1.7,  type:'powder' },
    glass:           { name:'Vidrio',      color:'#c8e8ff', density:2.5,  type:'solid'  },
    salt:            { name:'Sal',         color:'#f0f0f0', density:2.1,  type:'powder' },
    concrete_powder: { name:'P.HormigÃ³n',  color:'#a9a9a9', density:1.8,  type:'powder' },
    concrete:        { name:'HormigÃ³n',    color:'#888888', density:2.4,  type:'solid', resistant:true },
    brick:           { name:'Ladrillo',    color:'#b22222', density:2.0,  type:'solid', resistant:true },

    // ElÃ©ctricos & Especiales
    condenser: { name:'Condensador', color:'#4488aa', density:3, type:'solid' },
    firestone:  { name:'PiedraFuego',color:'#cc3300', density:3, type:'solid', hot:true  },
    harvester:  { name:'Cosechadora',color:'#ff6600', density:0, type:'special' },
    rubber:     { name:'Goma',       color:'#333333', density:1.2,type:'solid', insulator:true },
    bulb:       { name:'Bombilla',   color:'#998855', density:1,  type:'solid' },
    door:       { name:'Puerta',     color:'#7a4010', density:3,  type:'solid' },
    electricity: { name:'Electr.',   color:'#ffff00', density:0,  type:'energy', life:15 },
    metal:       { name:'Metal',     color:'#b8b8b8', density:7,  type:'solid', conductive:true },
    copper:      { name:'Cobre',     color:'#b87333', density:8.96,type:'solid',conductive:true },
    silver:      { name:'Plata',     color:'#c8c8c8', density:10.5,type:'solid',conductive:true },
    gold:        { name:'Oro',       color:'#ffd700', density:19.3,type:'solid',conductive:true },
    obsidian:    { name:'Obsidiana', color:'#0f0820', density:2.6, type:'solid' },
    portal:      { name:'Portal',    color:'#8b00ff', density:0,   type:'special' },

    // Fuego & Calor
    fire:      { name:'Fuego',    color:'#ff4500', density:0.1,  type:'gas',    life:60  },
    lava:      { name:'Lava',     color:'#ff4500', density:2,    type:'liquid', hot:true },
    magma:     { name:'Magma',    color:'#ff6600', density:3,    type:'liquid', hot:true },
    plasma:    { name:'Plasma',   color:'#ff00ff', density:0.08, type:'gas',    life:80, hot:true },
    wood:      { name:'Madera',   color:'#8b4513', density:0.6,  type:'solid',  flammable:true },
    coal:      { name:'CarbÃ³n',   color:'#1c1c1c', density:1.4,  type:'solid',  flammable:true },
    oil:       { name:'Aceite',   color:'#654321', density:0.8,  type:'liquid', flammable:true },
    petroleum: { name:'PetrÃ³leo', color:'#1a1a1a', density:0.85, type:'liquid', flammable:true },

    // Gases
    steam:    { name:'Vapor',     color:'#d8d8d8', density:0.05,    type:'gas', life:120 },
    smoke:    { name:'Humo',      color:'#505050', density:0.03,    type:'gas', life:150 },
    oxygen:   { name:'OxÃ­geno',   color:'#d6f0ff', density:0.0014,  type:'gas', life:250 },
    hydrogen: { name:'HidrÃ³geno', color:'#ffe6e6', density:0.00009, type:'gas', life:200, explosive:true },
    methane:  { name:'Metano',    color:'#90ee90', density:0.02,    type:'gas', life:200, explosive:true },
    nitrogen: { name:'NitrÃ³geno', color:'#add8e6', density:0.00125, type:'gas', life:300 },
    helium:   { name:'Helio',     color:'#ffc0cb', density:0.00018, type:'gas', life:400 },
    neon:     { name:'NeÃ³n',      color:'#ff6347', density:0.0009,  type:'gas', life:350 },
    ammonia:  { name:'AmonÃ­aco',  color:'#e0ffff', density:0.00073, type:'gas', life:180 },
    chlorine: { name:'Cloro',     color:'#ccff00', density:0.003,   type:'gas', life:180, toxic:true },

    // Metales & Minerales
    mercury:    { name:'Mercurio', color:'#c0c0c0', density:13.5, type:'liquid', toxic:true },
    sodium:     { name:'Sodio',    color:'#ffd700', density:0.97,  type:'solid',  reactive:true },
    uranium:    { name:'Uranio',   color:'#00ff00', density:19,    type:'solid'  },
    phosphorus: { name:'FÃ³sforo',  color:'#ffffe0', density:1.82,  type:'solid',  flammable:true },
    sulfur:     { name:'Azufre',   color:'#e8e800', density:2.07,  type:'powder', flammable:true },
    carbon:     { name:'Carbono',  color:'#3c3c3c', density:2.26,  type:'powder' },

    // Explosivos
    explosive: { name:'C4',      color:'#ffeb3b', density:1,   type:'solid'  },
    tnt:       { name:'TNT',     color:'#ff0000', density:1.5, type:'solid'  },
    gunpowder: { name:'PÃ³lvora', color:'#2f2f2f', density:1.3, type:'powder', explosive:true },
    neutron:   { name:'NeutrÃ³n', color:'#00ffff', density:0.5, type:'energy', life:50 },

    // BiologÃ­a
    plant: { name:'Planta',  color:'#32cd32', density:0.8, type:'solid'  },
    seed:  { name:'Semilla', color:'#a0522d', density:1.2, type:'powder' },
    ice:   { name:'Hielo',   color:'#87ceeb', density:0.9, type:'solid'  },

    // QuÃ­mica
    acid: { name:'Ãcido', color:'#adff2f', density:1.2, type:'liquid' },
};

// â”€â”€â”€ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initUI() {
    const materialGrid = document.getElementById('materialGrid');
    MATERIAL_ORDER.forEach(key => {
        if (key.startsWith('__')) {
            const t = document.createElement('div');
            t.className = 'mat-section-title';
            t.textContent = key.slice(2);
            materialGrid.appendChild(t);
            return;
        }
        const mat = MATERIALS[key]; if (!mat) return;
        const btn = document.createElement('button');
        btn.className = 'material-btn';
        btn.dataset.key = key;
        btn.innerHTML = `<div class="material-color" style="background:${mat.color}"></div><div>${mat.name}</div>`;
        btn.onclick = () => selectMaterial(key);
        materialGrid.appendChild(btn);
    });
    document.querySelector('.material-btn').classList.add('active');

    document.getElementById('eraserBtn').onclick = () => {
        isErasing = !isErasing;
        document.getElementById('eraserBtn').classList.toggle('active', isErasing);
        document.querySelectorAll('.material-btn').forEach(b => b.classList.remove('active'));
        canvas.style.cursor = isErasing ? 'cell' : 'crosshair';
    };
    document.getElementById('brushSize').oninput = e => {
        brushSize = parseInt(e.target.value);
        document.getElementById('brushValue').textContent = brushSize;
    };
    document.getElementById('clearBtn').onclick = () => {
        grid = Array(height).fill(null).map(() => Array(width).fill(null));
    };
    document.getElementById('pauseBtn').onclick = function () {
        isPaused = !isPaused;
        this.textContent = isPaused ? 'â–¶ï¸ Reanudar' : 'â¸ï¸ Pausar';
    };
}

function selectMaterial(key) {
    selectedMaterial = key; isErasing = false;
    document.getElementById('eraserBtn').classList.remove('active');
    canvas.style.cursor = 'crosshair';
    document.querySelectorAll('.material-btn').forEach(b => b.classList.toggle('active', b.dataset.key === key));
}

// â”€â”€â”€ MOVIMIENTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function movePowder(x, y) {
    const p = grid[y][x]; if (!p) return;
    const sp = Math.min(Math.ceil(p.density / 1.5), 3);
    for (let i = 1; i <= sp; i++) { if (y+i<height&&!grid[y+i][x]){grid[y+i][x]=p;grid[y][x]=null;return;} }
    const d = Math.random()<0.5?-1:1;
    if (y<height-1) {
        if (x+d>=0&&x+d<width&&!grid[y+1][x+d]){grid[y+1][x+d]=p;grid[y][x]=null;return;}
        if (x-d>=0&&x-d<width&&!grid[y+1][x-d]){grid[y+1][x-d]=p;grid[y][x]=null;}
    }
}
function moveLiquid(x, y) {
    const p=grid[y][x]; if(!p)return;
    if(y<height-1&&!grid[y+1][x]){grid[y+1][x]=p;grid[y][x]=null;return;}
    const d=Math.random()<0.5?-1:1;
    for(let i=1;i<=3;i++){if(x+d*i>=0&&x+d*i<width&&!grid[y][x+d*i]){grid[y][x+d*i]=p;grid[y][x]=null;return;}}
}
function moveGas(x, y, speed=0.8) {
    const p=grid[y][x]; if(!p)return;
    if(y>0&&Math.random()<speed){const nx=x+Math.floor(Math.random()*3)-1;if(nx>=0&&nx<width&&!grid[y-1][nx]){grid[y-1][nx]=p;grid[y][x]=null;}}
}
function explode(x, y, radius) {
    for(let dy=-radius;dy<=radius;dy+=2) for(let dx=-radius;dx<=radius;dx+=2){
        const dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<=radius){const nx=x+dx,ny=y+dy;if(nx>=0&&nx<width&&ny>=0&&ny<height&&Math.random()<(1-dist/radius)*0.8)grid[ny][nx]=dist<radius*0.4?{type:'plasma',life:60}:{type:'fire',life:50};}
    }
}
function propagateHeat(x,y,ht,r,prob,to) {
    const q=[[x,y,0]],vis=new Set([`${x},${y}`]);
    while(q.length){const[cx,cy,d]=q.shift();if(d>=r)continue;
        for(let dy=-1;dy<=1;dy++)for(let dx=-1;dx<=1;dx++){if(!dx&&!dy)continue;const nx=cx+dx,ny=cy+dy,k=`${nx},${ny}`;
            if(nx>=0&&nx<width&&ny>=0&&ny<height&&!vis.has(k)){vis.add(k);const n=grid[ny][nx];
                if(n&&n.type===ht&&Math.random()<prob/(d+1)){if(to)grid[ny][nx]={type:to};else n.heating=true;q.push([nx,ny,d+1]);}}}}
}

// â”€â”€â”€ ELECTRICIDAD: propagaciÃ³n por metales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isConductive(p) {
    if (!p) return false;
    if (p.type === 'rubber') return false; // Goma = aislante
    const mat = MATERIALS[p.type];
    return mat && mat.conductive;
}

function spreadElec(x, y) {
    for (let dy=-1; dy<=1; dy++) for (let dx=-1; dx<=1; dx++) {
        if (!dx&&!dy) continue;
        const nx=x+dx, ny=y+dy;
        if (nx<0||nx>=width||ny<0||ny>=height) continue;
        const nb = grid[ny][nx]; if (!nb) continue;
        if (nb.type === 'rubber') continue; // goma bloquea

        if (isConductive(nb) && !nb.electrified) {
            nb.electrified = true; nb.electrifiedTimer = 10;
        }
        if (nb.type === 'bulb') { nb.lit=true; nb.litTimer=12; }
        if (nb.type === 'door') { nb.powered=true; nb.poweredTimer=12; }
        if (nb.type === 'water' && !nb.electrified && Math.random()<0.25) {
            nb.electrified=true; nb.electrifiedTimer=4;
        }
    }
}

// â”€â”€â”€ PUERTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDoor(x, y) {
    const p = grid[y][x]; if (!p || p.type!=='door') return;
    if (p.poweredTimer>0) p.poweredTimer--;
    const on = p.powered && p.poweredTimer>0;
    if (on && !p.expanded) {
        // Expandir hacia los lados
        for (const ddx of [-1, 1]) {
            const nx = x+ddx;
            if (nx>=0 && nx<width && !grid[y][nx]) {
                grid[y][nx] = {type:'door', expanded:true, isExt:true, powered:true, poweredTimer:12};
                p.expanded = true;
            }
        }
    } else if (!on && p.expanded && !p.isExt) {
        // Contraer extensiones
        for (let ddx=-3; ddx<=3; ddx++) {
            const nx=x+ddx;
            if (nx>=0&&nx<width&&nx!==x) {
                const nb=grid[y][nx];
                if (nb&&nb.type==='door'&&nb.isExt) grid[y][nx]=null;
            }
        }
        p.expanded=false; p.powered=false;
    }
}

// â”€â”€â”€ UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateParticle(x, y) {
    const p = grid[y][x]; if (!p) return;
    const type = p.type;
    const mat = MATERIALS[type]; if (!mat) return;

    // Vida
    if (p.life !== undefined) {
        p.life--;
        if (p.life<=0) {
            grid[y][x] = (type==='fire'||type==='plasma')&&Math.random()<0.3 ? {type:'smoke',life:100} : null;
            return;
        }
    }

    // Electricidad
    if (type==='electricity') spreadElec(x, y);

    // Conductor activo: sigue propagando
    if (p.electrified && p.electrifiedTimer>0) {
        p.electrifiedTimer--;
        spreadElec(x, y);
        if (p.electrifiedTimer<=0) p.electrified=false;
    }

    // Bombilla: decremento del timer de luz
    if (type==='bulb' && p.litTimer>0) { p.litTimer--; if(p.litTimer<=0) p.lit=false; }

    // Puerta
    if (type==='door') updateDoor(x, y);

    // Movimiento
    if (mat.type==='powder') movePowder(x, y);
    else if (mat.type==='liquid') moveLiquid(x, y);
    else if (mat.type==='gas') {
        const sp = type==='hydrogen'?0.98:type==='helium'?0.99:type==='methane'?0.95:0.8;
        moveGas(x, y, sp);
    } else if (type==='harvester') {
        // Cosechadora: rebota horizontalmente, borra todo lo que toca
        if(!p.vx) p.vx = 1;
        const speed = 2;
        for(let s=0;s<speed;s++){
            const nx = x + p.vx;
            if(nx<0||nx>=width){
                p.vx = -p.vx;
                break;
            }
            const target = grid[y][nx];
            if(target && target.type!=='harvester'){
                // Borrar lo que toca
                grid[y][nx] = null;
            }
            if(!grid[y][nx]){
                grid[y][nx] = p;
                grid[y][x] = null;
                break;
            } else {
                // Bloqueado por algo inamovible (no deberÃ­a pasar tras borrar)
                p.vx = -p.vx;
                break;
            }
        }
        return;
        const vx=p.vx||1, vy=p.vy||0, nx=x+vx, ny=y+vy;
        if(nx>=0&&nx<width&&ny>=0&&ny<height&&!grid[ny][nx]){grid[ny][nx]=p;grid[y][x]=null;}
        else grid[y][x]=null;
        return;
    }

    checkReactions(x, y);
}

// â”€â”€â”€ REACCIONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkReactions(x, y) {
    const p = grid[y][x]; if (!p) return;
    const type = p.type;

    for (let dy=-1; dy<=1; dy++) for (let dx=-1; dx<=1; dx++) {
        if (!dx&&!dy) continue;
        const nx=x+dx, ny=y+dy;
        if (nx<0||nx>=width||ny<0||ny>=height) continue;
        const nb = grid[ny][nx]; if (!nb) continue;

        // â”€â”€ CONDENSADOR: vapor â†’ agua â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (type==='condenser' && nb.type==='steam' && Math.random()<0.3) {
            grid[ny][nx] = {type:'water'};
            continue;
        }

        // â”€â”€ PIEDRA DE FUEGO: agua â†’ vapor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (type==='firestone' && nb.type==='water' && Math.random()<0.2) {
            grid[ny][nx] = {type:'steam', life:160};
            continue;
        }

        // â”€â”€ GOMA: bloquea todo elÃ©ctrico â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (type==='rubber'||nb.type==='rubber') {
            // goma no reacciona, pero sÃ­ bloquea electricidad (ya manejado en spreadElec)
            continue;
        }

        // â”€â”€ ELECTRICIDAD â†’ conductores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if ((type==='electricity'||(p.electrified&&p.electrifiedTimer>0)) && nb.type!=='rubber') {
            if (isConductive(nb) && !nb.electrified) { nb.electrified=true; nb.electrifiedTimer=10; }
            if (nb.type==='bulb') { nb.lit=true; nb.litTimer=12; }
            if (nb.type==='door') { nb.powered=true; nb.poweredTimer=12; }
            // Explosivos con electricidad
            if ((nb.type==='explosive'||nb.type==='tnt') && Math.random()<0.5) { explode(nx,ny,nb.type==='tnt'?20:15); return; }
        }

        // â”€â”€ SODIO + AGUA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if ((type==='sodium'&&nb.type==='water')||(type==='water'&&nb.type==='sodium')) {
            explode(x,y,18);
            for(let i=0;i<12;i++){const a=Math.PI*2*i/12,fx=Math.round(x+Math.cos(a)*8),fy=Math.round(y+Math.sin(a)*8);if(fx>=0&&fx<width&&fy>=0&&fy<height&&!grid[fy][fx])grid[fy][fx]={type:'hydrogen',life:150};}
            return;
        }

        // â”€â”€ Hâ‚‚ + Oâ‚‚ + fuego â†’ AGUA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if ((type==='hydrogen'&&nb.type==='oxygen')||(type==='oxygen'&&nb.type==='hydrogen')) {
            let fire=false;
            outer: for(let sy=-3;sy<=3;sy++) for(let sx=-3;sx<=3;sx++){const cy=y+sy,cx=x+sx;if(cx>=0&&cx<width&&cy>=0&&cy<height){const c=grid[cy][cx];if(c&&(c.type==='fire'||c.type==='plasma'||c.type==='lava'||c.type==='electricity')){fire=true;break outer;}}}
            if(fire&&Math.random()<0.12){explode(x,y,8);grid[y][x]={type:'water'};grid[ny][nx]={type:'water'};for(let i=0;i<4;i++){const a=Math.PI*2*i/4,fx=Math.round(x+Math.cos(a)*3),fy=Math.round(y+Math.sin(a)*3);if(fx>=0&&fx<width&&fy>=0&&fy<height&&!grid[fy][fx])grid[fy][fx]={type:'steam',life:120};}return;}
            if(!fire&&Math.random()<0.004){grid[y][x]={type:'water'};grid[ny][nx]=null;return;}
        }

        // â”€â”€ FÃ“SFORO + Oâ‚‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if((type==='phosphorus'&&nb.type==='oxygen')||(type==='oxygen'&&nb.type==='phosphorus'))
            if(Math.random()<0.1){grid[y][x]={type:'fire',life:120};grid[ny][nx]={type:'fire',life:120};return;}

        // â”€â”€ LAVA/MAGMA + AGUA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='lava'&&nb.type==='water'){grid[y][x]={type:'stone'};grid[ny][nx]={type:'steam',life:100};for(let i=0;i<4;i++){const a=Math.PI*2*i/4,fx=Math.round(x+Math.cos(a)*2),fy=Math.round(y+Math.sin(a)*2);if(fx>=0&&fx<width&&fy>=0&&fy<height&&!grid[fy][fx])grid[fy][fx]={type:'steam',life:80};}return;}
        if(type==='magma'&&nb.type==='water'){grid[y][x]={type:'lava'};grid[ny][nx]={type:'steam',life:120};explode(x,y,8);return;}

        // â”€â”€ COMBUSTIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if((type==='fire'||type==='lava'||type==='plasma'||type==='magma')&&Math.random()<0.2){
            if(nb.type==='oil'||nb.type==='petroleum') grid[ny][nx]={type:'fire',life:120};
            else if(nb.type==='wood'&&!nb.burning){nb.burning=true;nb.burnTime=150;}
            else if(nb.type==='gunpowder'){explode(nx,ny,10);return;}
            else if(nb.type==='plant') grid[ny][nx]={type:'fire',life:50};
            else if(nb.type==='methane'){explode(nx,ny,15);return;}
            else if(nb.type==='coal'&&!nb.burning){nb.burning=true;nb.burnTime=300;}
            else if(nb.type==='sulfur'){grid[ny][nx]={type:'fire',life:80};propagateHeat(nx,ny,'sulfur',3,0.4,'fire');}
            else if(nb.type==='phosphorus') grid[ny][nx]={type:'fire',life:100};
            else if(nb.type==='oxygen') grid[ny][nx]=null;
            else if(nb.type==='hydrogen'&&Math.random()<0.3){explode(nx,ny,6);grid[ny][nx]={type:'water'};return;}
        }

        // â”€â”€ EXPLOSIVOS + fuego â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if((type==='explosive'||type==='tnt')&&(nb.type==='fire'||nb.type==='lava'||nb.type==='plasma')){explode(x,y,type==='tnt'?20:15);return;}

        // â”€â”€ HIELO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='ice'&&Math.random()<0.02){
            if(nb.type==='water'){grid[ny][nx]={type:'ice'};propagateHeat(nx,ny,'water',4,0.3,'ice');}
            else if(nb.type==='fire'||nb.type==='lava') grid[ny][nx]={type:'water'};
        }

        // â”€â”€ SEMILLA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='seed'&&nb.type==='water'&&Math.random()<0.05){grid[y][x]={type:'plant',growth:0};if(y>0&&!grid[y-1][x])grid[y-1][x]={type:'plant',growth:0};return;}

        // â”€â”€ TIERRA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='dirt'&&nb.type==='water'&&!p.wet&&Math.random()<0.1){p.wet=true;p.color='#3d2817';grid[ny][nx]=null;propagateHeat(x,y,'dirt',5,0.4,null);}

        // â”€â”€ HORMIGÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='concrete_powder'&&nb.type==='water'&&Math.random()<0.3){grid[y][x]={type:'concrete'};if(Math.random()<0.5)grid[ny][nx]=null;propagateHeat(x,y,'concrete_powder',8,0.5,'concrete');return;}

        // â”€â”€ ARCILLA â†’ LADRILLO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='clay'&&(nb.type==='lava'||nb.type==='fire'||nb.type==='plasma'||nb.type==='magma')&&Math.random()<0.08){grid[y][x]={type:'brick'};propagateHeat(x,y,'clay',15,0.6,'brick');return;}

        // â”€â”€ ARENA â†’ VIDRIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='lava'&&nb.type==='sand'&&Math.random()<0.08){grid[ny][nx]={type:'glass'};propagateHeat(nx,ny,'sand',4,0.4,'glass');}

        // â”€â”€ ÃCIDO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='acid'&&Math.random()<0.15){
            if(nb.type==='metal'||nb.type==='copper'||nb.type==='silver'){grid[ny][nx]={type:'smoke',life:80};if(Math.random()<0.3)grid[y][x]=null;}
            else if(nb.type==='stone'||nb.type==='concrete'){if(Math.random()<0.05)grid[ny][nx]={type:'sand',color:'#888'};}
            else if(nb.type==='wood'||nb.type==='plant') grid[ny][nx]={type:'smoke',life:60};
        }

        // â”€â”€ CLORO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='chlorine'&&Math.random()<0.1){
            if(nb.type==='sodium'){grid[y][x]={type:'salt'};grid[ny][nx]={type:'salt'};return;}
            if(nb.type==='hydrogen'){grid[y][x]={type:'acid'};grid[ny][nx]=null;return;}
        }

        // â”€â”€ URANIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='uranium'&&nb.type==='neutron'&&Math.random()<0.5){explode(x,y,20);for(let i=0;i<8;i++){const a=Math.PI*2*i/8,fx=Math.round(x+Math.cos(a)*5),fy=Math.round(y+Math.sin(a)*5);if(fx>=0&&fx<width&&fy>=0&&fy<height)grid[fy][fx]={type:'neutron',life:50,vx:Math.round(Math.cos(a)*2),vy:Math.round(Math.sin(a)*2)};}return;}

        // â”€â”€ MERCURIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='mercury'&&nb.type==='metal'&&Math.random()<0.03) grid[ny][nx]={type:'mercury'};

        // â”€â”€ AMONÃACO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='ammonia'&&nb.type==='fire'&&Math.random()<0.15){explode(x,y,10);for(let i=0;i<6;i++){const a=Math.PI*2*i/6,fx=Math.round(x+Math.cos(a)*4),fy=Math.round(y+Math.sin(a)*4);if(fx>=0&&fx<width&&fy>=0&&fy<height)grid[fy][fx]={type:'nitrogen',life:150};}return;}

        // â”€â”€ PORTAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if(type==='portal'&&Math.random()<0.05&&nb.type!=='portal'&&nb.type!=='obsidian'){
            for(let py=Math.max(0,y-100);py<Math.min(height,y+100);py+=5) for(let px=Math.max(0,x-100);px<Math.min(width,x+100);px+=5){
                const pp=grid[py][px];if(pp&&pp.type==='portal'&&(px!==x||py!==y)){for(let ty=-2;ty<=2;ty++)for(let tx=-2;tx<=2;tx++){const tpx=px+tx,tpy=py+ty;if(tpx>=0&&tpx<width&&tpy>=0&&tpy<height&&!grid[tpy][tpx]){grid[tpy][tpx]=nb;grid[ny][nx]=null;return;}}}
            }
        }
    }

    // â”€â”€ COMPORTAMIENTOS ESPECIALES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if(type==='wood'&&p.burning){p.burnTime=(p.burnTime||150)-1;if(p.burnTime<=0)grid[y][x]={type:'fire',life:30};else if(Math.random()<0.1&&y>0&&!grid[y-1][x])grid[y-1][x]={type:'smoke',life:120};}
    if(type==='coal'&&p.burning){p.burnTime=(p.burnTime||300)-1;if(p.burnTime<=0)grid[y][x]=null;else if(Math.random()<0.15&&y>0&&!grid[y-1][x])grid[y-1][x]={type:'fire',life:70};}
    if(type==='plant'){
        // Absorber agua adyacente y resetear timer
        const waterDirs=[[0,1],[0,-1],[1,0],[-1,0]];
        let absorbedWater=false;
        for(const[wd,wdy] of [[1,0],[-1,0],[0,1],[0,-1],[1,1],[-1,1],[1,-1],[-1,-1]]){
            const wx=x+wd,wy=y+wdy;
            if(wx>=0&&wx<width&&wy>=0&&wy<height&&grid[wy][wx]&&grid[wy][wx].type==='water'&&Math.random()<0.15){
                grid[wy][wx]=null; absorbedWater=true; break;
            }
        }
        if(absorbedWater){ p.waterTimer=0; if(p.dried){p.dried=false;p.color=undefined;} }
        else { p.waterTimer=(p.waterTimer||0)+1; }
        // Secar si lleva mucho tiempo sin agua
        if(p.waterTimer>900&&!p.dried){ p.dried=true; p.color='#c8a060'; }
        // Crecer solo si tiene suficiente agua reciente
        if(!p.dried && p.waterTimer<300 && Math.random()<0.015){
            p.growth=(p.growth||0)+1;
            if(p.growth<5){
                const dirs=[[0,-1],[-1,0],[1,0]],d=dirs[Math.floor(Math.random()*3)],nx=x+d[0],ny=y+d[1];
                if(nx>=0&&nx<width&&ny>=0&&ny<height&&!grid[ny][nx])grid[ny][nx]={type:'plant',growth:0,waterTimer:p.waterTimer};
            }
        }
    }
    if(type==='uranium'&&Math.random()<0.01){const a=Math.random()*Math.PI*2,nx=Math.round(x+Math.cos(a)),ny=Math.round(y+Math.sin(a));if(nx>=0&&nx<width&&ny>=0&&ny<height&&!grid[ny][nx])grid[ny][nx]={type:'neutron',life:50,vx:Math.round(Math.cos(a)*2),vy:Math.round(Math.sin(a)*2)};}
    if(type==='obsidian'&&Math.random()<0.02) checkPortalFrame(x,y);
}

// â”€â”€â”€ PORTAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkPortalFrame(x,y){
    for(let w=3;w<=6;w++) for(let h=4;h<=8;h++){
        if(!isValidPortalFrame(x,y,w,h)) continue;
        let fire=false;
        outer: for(let dy=1;dy<h-1;dy++) for(let dx=1;dx<w-1;dx++){const c=grid[y+dy][x+dx];if(c&&(c.type==='fire'||c.type==='lava'||c.type==='plasma')){fire=true;break outer;}}
        if(fire){for(let dy=1;dy<h-1;dy++) for(let dx=1;dx<w-1;dx++) grid[y+dy][x+dx]={type:'portal'};return;}
    }
}
function isValidPortalFrame(x,y,w,h){
    if(x+w>width||y+h>height) return false;
    for(let dx=0;dx<w;dx++){if(!grid[y][x+dx]||grid[y][x+dx].type!=='obsidian')return false;if(!grid[y+h-1][x+dx]||grid[y+h-1][x+dx].type!=='obsidian')return false;}
    for(let dy=0;dy<h;dy++){if(!grid[y+dy][x]||grid[y+dy][x].type!=='obsidian')return false;if(!grid[y+dy][x+w-1]||grid[y+dy][x+w-1].type!=='obsidian')return false;}
    return true;
}

// â”€â”€â”€ INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
canvas.addEventListener('mousedown', e=>{isDrawing=true;applyTool(e);});
canvas.addEventListener('mousemove', e=>{if(isDrawing)applyTool(e);});
canvas.addEventListener('mouseup',   ()=>{isDrawing=false;});
canvas.addEventListener('mouseleave',()=>{isDrawing=false;});

function applyTool(e){
    const rect=canvas.getBoundingClientRect();
    const x=Math.floor((e.clientX-rect.left)/pixelSize);
    const y=Math.floor((e.clientY-rect.top)/pixelSize);
    for(let dy=-brushSize;dy<=brushSize;dy++) for(let dx=-brushSize;dx<=brushSize;dx++){
        if(Math.sqrt(dx*dx+dy*dy)<=brushSize){
            const px=x+dx,py=y+dy;
            if(px>=0&&px<width&&py>=0&&py<height){
                if(isErasing) grid[py][px]=null;
                else if(!grid[py][px]) grid[py][px]={type:selectedMaterial};
            }
        }
    }
}

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(){
    ctx.fillStyle='#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const t=Date.now();
    for(let y=0;y<height;y++) for(let x=0;x<width;x++){
        const p=grid[y][x]; if(!p) continue;
        const mat=MATERIALS[p.type]; if(!mat) continue;
        let c=mat.color;
        if(p.color) c=p.color;
        else if(p.type==='lava'){const v=Math.sin(t/200)*0.2+0.8;c=`rgb(${255*v|0},${69*v|0},0)`;}
        else if(p.type==='magma'){const v=Math.sin(t/150)*0.3+0.7;c=`rgb(${255*v|0},${102*v|0},0)`;}
        else if(p.type==='plasma'){const v=Math.sin(t/100)*0.5+0.5;c=`rgb(${255*v|0},0,${255*(1-v)|0})`;}
        else if(p.type==='portal'){const v=Math.sin(t/100)*0.3+0.7;c=`rgb(${139*v|0},0,${255*v|0})`;}
        else if(p.type==='uranium'){const v=Math.sin(t/300)*0.3+0.7;c=`rgb(0,${255*v|0},0)`;}
        else if(p.type==='electricity'){const v=Math.random();c=`rgb(${255*v|0},${255*v|0},0)`;}
        // Conductor electrificado: pulso azul-blanco
        else if(p.electrified&&p.electrifiedTimer>0){const v=Math.sin(t/50)*0.5+0.5;c=`rgb(${100+155*v|0},${150+105*v|0},255)`;}
        // Bombilla encendida
        else if(p.type==='bulb'&&p.lit){const v=Math.sin(t/80)*0.3+0.7;c=`rgb(255,${230+25*v|0},${80*v|0})`;}
        // Bombilla apagada: gris oscuro
        else if(p.type==='bulb'&&!p.lit) c='#555544';
        // Puerta con corriente
        else if(p.type==='door'&&p.powered&&p.poweredTimer>0){const v=Math.sin(t/100)*0.2+0.8;c=`rgb(${200*v|0},${100*v|0},${20*v|0})`;}
        // Cosechadora
        else if(p.type==='harvester'){const v=Math.sin(t/80)*0.3+0.7;c=`rgb(255,${100+60*v|0},0)`;}
        // Condensador
        else if(p.type==='condenser'){const v=Math.sin(t/800)*0.08+0.92;c=`rgb(${68*v|0},${136*v|0},${180*v|0})`;}
        // Piedra de Fuego
        else if(p.type==='firestone'){const v=Math.sin(t/200)*0.25+0.75;c=`rgb(${210*v|0},${45*v|0},0)`;}
        // Goma
        else if(p.type==='rubber') c='#2a2a2a';

        ctx.fillStyle=c;
        ctx.fillRect(x*pixelSize,y*pixelSize,pixelSize,pixelSize);
    }
}

// â”€â”€â”€ LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let frameCount=0;
function update(){
    if(!isPaused){
        frameCount++;
        const ltr=frameCount%2===0;
        for(let y=height-1;y>=0;y--){
            if(ltr){for(let x=0;x<width;x++){if(grid[y][x])updateParticle(x,y);}}
            else    {for(let x=width-1;x>=0;x--){if(grid[y][x])updateParticle(x,y);}}
        }
    }
    render();
    requestAnimationFrame(update);
}

initUI();
update();
</script>
</body>
</html>
